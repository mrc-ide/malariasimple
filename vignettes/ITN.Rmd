---
title: "Insecticide Treated Nets"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Insecticide Treated Nets}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{css, echo=FALSE}
img {
  border: none;
}
```

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dpi = 300,
  fig.width = 7
)
```

```{r setup}
library(malariasimple)
```

Insecticide treated nets (ITNs) can be introduced into a simulation using the `set_bednets()` function. 

## Introduction
In `malariasimple`, ITNs interrupt the feeding cycle of mosquitoes. Upon attempting to feed on a human protected by an ITN, three things can occur:

- The mosquito successfully feeds and continues to oviposit (probability = $s_{n}$)
- The mosquito dies (probability = $d_{n}$)
- The mosquito is thwarted by the net, but survives and searches for a new host (probability = $r_{n}$)

Hence, the effectiveness of an ITN intervention depends on how many people are currently using ITNs and how successful those ITNs at a given time at killing or repelling mosquitoes. These factors can be parameterised using the `set_bednets()` function.

## Parameters
Efficacy of an ITN distribution is assumed to wane over time by two mechanisms: 

- **ITN insecticide decay**. Decay is assumed exponential and is defined by its half-life in days `gamman` 
- **ITN loss**. The model assumes that ITNs are retained for `retention` days, after which the net is no longer used. This is a deterministic approximatation of `malariasimulation` where net retention varies between individuals, but are kept for an *average* of `retention` days. 

Three more parameters are required to fully parametrise the ITNs.

- `dn0` Probability of mosquito dying upon encounter with brand new net
- `rn` Probability mosquito being repelled upon encounter with brand new net
- `rnm` Probability of mosquito being repelled upon encounter with old net (fully decayed insecticide)


## ITN Distribution Types
There are two types of ITN distribution covered in `malariasimple`. 

### 1. Discrete

This is the default. The model assumes that ITNs are distributed on discrete distribution events (`days`) to a specified random proportion of the population (`coverages`).

**Using set_bednets() with discrete distibution**

```{r, message = FALSE, results = "hide", fig.align = 'center', out.width='100%', fig.asp=0.6}
n_days <- 2*365
## ------------------  Define ITN parameters --------------------------
itn_days <- c(100,200,350) #Days on which ITN distribution events occur
itn_cov <- c(0.1,0.4,0.5) #Proportion of the population who receive an ITN on each distribution event
gamman <- 2.64*365 #Half-life of insecticide
retention <- 5*365 #People keep their nets for 5 years


## -------------  Set up malariasimple parameters ----------------------
discrete_params = malariasimple::get_parameters(n_days = n_days,
                            age_vector = c(0,1,2,5,10,20,40,60,80)*365) |>
  malariasimple::set_bednets(days = itn_days,
          coverages = itn_cov,
          gamman = gamman,
          retention = retention) |>
  malariasimple::set_equilibrium(init_EIR = 5)

## ---------------------- Run simulation ------------------------------
discrete_out <- malariasimple::run_simulation(discrete_params) |> as.data.frame()

## -----------------------  Plot  -------------------------------------
plot(discrete_out$time, discrete_out$n_detect_730_3650/discrete_out$n_730_3650,
     type = "l", lwd = 2, main = "Discrete Distributions",
     xlab = "Day", ylab =  expression(paste(italic(Pf),"PR"[2-10])))
abline(v = itn_days, lty = 2)
legend("topright", legend = "ITN distributions", lty = 2, bty = "n")


```
**Visualising discrete parameters**

`set_bednets()` tracks the usage and average insecticide decay from each distribution event. These can be visualised using the intermediate functions `get_itn_usage_mat()` and `get_decay_mat()`. Because the model only has one compartment for each intervention, the model takes the total usage and mean decay at each time point when running the simulation. Below, we plot the input model assumptions.  

```{r, message = FALSE, results = "hide", fig.align = 'center', out.width='100%', fig.asp=1}
## -------------  Return usage and decay matrices ----------------------
usage_mat <- get_itn_usage_mat(itn_days, itn_cov, retention, n_days)
decay_mat <- get_decay_mat(itn_days, n_days, gamman_itn = gamman, intervention = "ITN")

## -----------------------  Plot  --------------------------------
t <- 1:n_days
colours <- c("#1B9E77", "#D95F02", "#7570B3")
par(mfrow = c(2, 1), mar = c(4, 4, 2, 1), cex = 0.8) 

#Usage plot
matplot(t, usage_mat[, 1:length(itn_days)], type = "l", lty = 1, col = colours, ylim = c(0,1),
        xlab = "Time", ylab = "ITN usage", main = "ITN Usage by Distribution Event")
lines(1:n_days, discrete_params$itn_eff_cov_daily[2:(n_days+1)] * discrete_params$max_itn_cov,
      col = "black", lwd = 2, lty = 2)
legend("topleft",
       legend = c("Distribution event 1", "Distribution event 2", "Distribution event 3", "Total ITN usage"),
       col = c(colours, "black"),
       lty = c(1, 1, 1, 2),
       lwd = c(1, 1, 1, 2),
       bty = "n") 

#Decay plot
matplot(t, decay_mat[, 1:length(itn_days)], type = "l", lty = 1, col = colours, ylim = c(0,1),
        xlab = "Time", ylab = "Insecticide Efficacy", main = "ITN Decay by Distribution Event")
lines(1:(n_days+1), discrete_params$itn_decay_daily, col = "red", lwd = 2, lty = 2)
lines(t, get_daily_decay(usage_mat, decay_mat), col = "red", lwd = 2, lty = 2)
legend("bottomright",
       legend = c("Distribution event 1", "Distribution event 2", "Distribution event 3", "Mean ITN efficacy"),
       col = c(colours, "red"),
       lty = c(1, 1, 1, 2),
       lwd = c(1, 1, 1, 2),
       bty = "n") 
```

### 2. Continuous

The model assumes that ITNs are continually distributed with individuals replacing their nets every `retention` days. 

**Using set_bednets() with continuous distribution**
```{r, message = FALSE, results = "hide", fig.align = 'center', out.width='100%', fig.asp=0.55}
## ------------------  Define ITN parameters --------------------------
itn_coverage_data <- data.frame(day = c(1,365,2*365),
                                cov = c(0.2,0.3,0.8))
daily_continuous_cov <- approx(itn_coverage_data$day, itn_coverage_data$cov, xout = 1:n_days)$y

## -------------  Set up malariasimple parameters ----------------------
continuous_params = malariasimple::get_parameters(n_days = 2*365,
                                   age_vector = c(0,1,2,5,10,20,40,60,80)*365) |>
  malariasimple::set_bednets(continuous_distribution = TRUE,
          daily_continuous_cov = daily_continuous_cov) |>
  malariasimple::set_equilibrium(init_EIR = 5)

## ---------------------- Run simulation ------------------------------
continuous_out <- malariasimple::run_simulation(continuous_params) |> as.data.frame()

## -----------------------  Plot  -------------------------------------
plot(continuous_out$time, continuous_out$n_detect_730_3650/continuous_out$n_730_3650,
     type = "l", lwd = 2, main = "Continuous Distribution",
     xlab = "Day", ylab =  expression(paste(italic(Pf),"PR"[2-10])))
```

**Visualising continuous parameters**

Under the continuous assumption, insecticide decay is considered constant (equal to mean decay over `retention` period). ITN coverage is input directly as a daily time series `daily_continuous_cov`.

```{r, message = FALSE, results = "hide", fig.align = 'center', out.width='100%', fig.asp=0.6}
## -----------------------  Plot --------------------------------------
par(cex = 0.8)
plot(1:n_days, daily_continuous_cov, type = "l", xlab = "Time", ylab = "", ylim = c(0,1),
     lty = 2, lwd = 2)
lines(1:n_days, continuous_params$itn_decay_daily[2:(n_days+1)], col = "red",
      lty = 2, lwd = 2)
legend("bottomright",
       legend = c("Total ITN usage", "Mean ITN efficacy"),
       col = c("black", "red"),
       lty = c(2,2),
       lwd = c(2,2),
       bty = "n") 
```






