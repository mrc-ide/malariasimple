---
title: "Insecticide Treated Nets"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{ITN}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{css, echo=FALSE}
img {
  border: none;
}
```

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dpi = 300,
  fig.width = 7
)
```

```{r setup}
library(malariasimple)
```

Insecticide treated nets (ITNs) can be introduced into a simulation using the `set_itn()` function. 

## Introduction
In `malariasimple`, ITNs interrupt the feeding cycle of mosquitoes. Upon attempting to feed on a human protected by an ITN, three things can occur:

- The mosquito successfully feeds and continues to oviposit (probability = $s_{n}$)
- The mosquito dies (probability = $d_{n}$)
- The mosquito is thwarted by the net, but survives and searches for a new host (probability = $r_{n}$)

```{r, echo = FALSE, out.width="100%"}
knitr::include_graphics("images/itns.png")
```

Hence, the effectiveness an ITN intervention depends on how many people are currently using ITNs and how successful those ITNs at a given time at killing mosquitoes (or at least thwarting attempts at biting humans). These factors can be parameterised using the `set_itn()` function.

#### ITN parameters
- `dn0` Probability of mosquito dying upon encounter with brand new net
- `rn` Probability mosquito being repelled upon encounter with brand new net
- `rnm` Probability of mosquito being repelled upon encounter with old net (fully decayed insecticide)
- `gamman` Half-life of ITN insecticide

Insecticide is assumed to decay exponentially according to half-life `gamman`.

#### ITN usage parameters
**Retention**

Individuals are assumed to retain and use their net for a set number of days (`retention`), and then discard it. The default is 3 years.

**Distribution**

There are two types of ITN distribution covered in `malariasimple`. 

1. *Discrete*. This assumes that ITNs are distributed on discrete distribution events (`itn_days`) to a specified random proportion of the population (`itn_cov`). This is the default. 

2. *Continuous*. This assumes that ITNs are continually distributed. The ITN coverage can be set to vary over time according to a user defined time series (`daily_continuous_cov`)


## Using set_itn()
Example assuming discrete ITN  distribution:
```{r, message = FALSE, results = "hide", fig.align = 'center', out.width='100%', fig.asp=0.55}
## -------------  Define ITN parameters ------------------------------
itn_days <- c(100,200,350) #Days on which ITN distribution events occur
itn_cov <- c(0.1,0.4,0.5) #Proportion of the population who receive an ITN on each distribution event
gamman <- 2.64*365 #Half-life of insecticide 
retention <- 5*365 #People keep their nets for 5 years

## -------------  Set up malariasimple parameters and run  ----------
discrete_params = get_parameters(n_days = 2*365,
                            age_vector = c(0,1,2,5,10,20,40,60,80)*365) |>
  set_itn(itn_days = itn_days,
          itn_cov = itn_cov,
          gamman = gamman,
          retention = retention) |>
  set_equilibrium(init_EIR = 5)

discrete_out <- run_simulation(discrete_params) |> as.data.frame()

## --------------------  Plot  -------------------------------------
plot(discrete_out$time, discrete_out$n_detect_730_3650/discrete_out$n_730_3650,
     type = "l", lwd = 2, main = "Discrete Distributions",
     xlab = "Day", ylab =  expression(paste(italic(Pf),"PR"[2-10])))
abline(v = itn_days, lty = 2)
legend("topright", legend = "ITN distributions", lty = 2, bty = "n")
```
Example assuming continuous ITN  distribution:
```{r, message = FALSE, results = "hide", fig.align = 'center', out.width='100%', fig.asp=0.55}
## -------------  Define ITN parameters ------------------------------
n_days <- 2*365
daily_coverage <- 0.2 + 0.15*(sin(2 * pi * (1:n_days / 365)) + 1) #Assume seasonally varying coverage

## -------------  Set up malariasimple parameters and run  ----------
continuous_params = get_parameters(n_days = 2*365,
                            age_vector = c(0,1,2,5,10,20,40,60,80)*365) |>
  set_itn(continuous_distribution = TRUE,
          daily_continuous_cov = daily_coverage) |>
  set_equilibrium(init_EIR = 5)

continuous_out <- run_simulation(continuous_params) |> as.data.frame()

## --------------------  Plot  -------------------------------------
plot(continuous_out$time, continuous_out$n_detect_730_3650/continuous_out$n_730_3650,
     type = "l", lwd = 2, main = "Continuous Distribution",
     xlab = "Day", ylab =  expression(paste(italic(Pf),"PR"[2-10])))

```
