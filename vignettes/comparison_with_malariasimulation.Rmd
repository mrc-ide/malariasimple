---
title: "Comparison with malariasimulation"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Comparison with malariasimulation}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

`malariasimple` is designed to resemble `malariasimulation` as closely as possible. However, there are certain scenarios (e.g. fast, low resolution runs; low population/transmission scenarios) where `malariasimple` may not provide a useful approximation. If in doubt, it is a good idea to check your `malariasimple` simulation against an equivalent `malariasimulation` run. In this vignette we will demonstrate an example comparing equivalent simulations of `malariasimulation` and`malariasimple`.

Note: `malariasimple` is designed to be familiar to users of `malariasimulation` and hence many similar functions have the same name. Hence, when both libraries are loaded in an R session simultaneously, it becomes necessary to state which version of a function you are calling by using the :: operator. 

```{r, message = FALSE}
library(malariasimple)
library(malariasimulation)
set.seed(101)
```

## Example

#### Set up parameters
```{r,message = FALSE}
n_years <- 3
human_pop <- 5000
n_days <- n_years*365
init_EIR <- 50
num_sims <- 10 #Number of parallel stochastic simulations
fine_age_vector <- c(seq(0,10,by=0.25), 15, 20, seq(30,90, by = 10)) * 365 #A fine age vector will give a malariasimple output closer to malariasimulation at the expense of simulation speed. 

##Seasonality parameters
g0 = 0.28
g = c(-0.3, -0.03, 0.17)
h = c(-0.35, 0.32, -0.07)

##Define ITN parameters
itn_days <- c(100,365,500,800)
itn_cov <- c(0.1,0.4,0.5,0.1)
gamman <- 2.64*365
retention <- 5*365

##Define IRS parameters
irs_days <- c(400, 600)
irs_cov <- c(0.7, 0.8)
ls_theta <- 2.025 #Initial efficacy
ls_gamma <- -0.009 #How efficacy changes over time
ks_theta <- -2.222 #Initial proportion of mosquitoes successfully feeding
ks_gamma <- -1.232 #Change in successful feeding
ms_theta <- -1.232 #Initial repellency
ms_gamma <- -0.009

n_dist <- length(itn_days)
dn0 <- rep(0.41, n_dist)
rn <- rep(0.56, n_dist)
rnm <- rep(0.24, n_dist)
gamman_vec <- rep(gamman, n_dist)
```

### malariasimulation
```{r}
##Set up malariasimulation parameters
n_dist <- length(itn_days)
dn0 <- rep(0.41, n_dist)
rn <- rep(0.56, n_dist)
rnm <- rep(0.24, n_dist)
gamman_vec <- rep(gamman, n_dist)

malsim_params <- malariasimulation::get_parameters(
  overrides = list(
    model_seasonality = TRUE,
    g0 = g0,
    g = g,
    h = h,
    clinical_incidence_rendering_min_ages = 0,
    clinical_incidence_rendering_max_ages = 100 * 365,
    prevalence_rendering_min_ages = 2 * 365,
    prevalence_rendering_max_ages = 10 * 365,
    human_population = human_pop
  )
) |> malariasimulation::set_spraying(
  timesteps = irs_days,
  coverages = irs_cov,
  ls_theta = matrix(ls_theta, nrow=length(irs_days), ncol=1), 
  ls_gamma = matrix(ls_gamma, nrow=length(irs_days), ncol=1), 
  ks_theta = matrix(ks_theta, nrow=length(irs_days), ncol=1), 
  ks_gamma = matrix(ks_gamma, nrow=length(irs_days), ncol=1), 
  ms_theta = matrix(ms_theta, nrow=length(irs_days), ncol=1), 
  ms_gamma = matrix(ms_gamma, nrow=length(irs_days), ncol=1) 
)|>
  malariasimulation::set_bednets(
    timesteps = itn_days,
    coverages = itn_cov,
    retention = retention,
    dn0 = matrix(dn0, nrow = n_dist, ncol = 1),
    rn = matrix(rn, nrow = n_dist, ncol = 1),
    rnm = matrix(rnm, nrow = n_dist, ncol = 1),
    gamman = gamman_vec
  ) |>
  malariasimulation::set_equilibrium(init_EIR = init_EIR)

##Run malariasimulation
malsim <- malariasimulation::run_simulation_with_repetitions(
  timesteps = n_days,
  repetitions = num_sims,
  overrides = malsim_params,
  parallel = TRUE
)
```

### malariasimple
```{r}
##Set up malariasimple parameters
simple_params <- malariasimple::get_parameters(
  n_days = n_days,
  prevalence_rendering_min_ages = 2 * 365,
  prevalence_rendering_max_ages = 10 * 365,
  age_vector = fine_age_vector,
  human_pop = human_pop
) |>
  malariasimple::set_seasonality(
    g0 = g0,
    g = g,
    h = h
  ) |>
  malariasimple::set_bednets(
    days = itn_days,
    coverages = itn_cov,
    gamman = gamman,
    retention = retention
  ) |> malariasimple::set_spraying(days = irs_days,
                                 coverages = irs_cov,
                                 distribution_type = "random",
                                 ls_theta = ls_theta,
                                 ls_gamma = ls_gamma,
                                 ks_theta = ks_theta,
                                 ks_gamma = ks_gamma,
                                 ms_theta = ms_theta,
                                 ms_gamma = ms_gamma) |>
  malariasimple::set_equilibrium(init_EIR = init_EIR)

##Run malariasimple
simple <- malariasimple::run_simulation(simple_params) |> as.data.frame()
```



### Plot
```{r, fig.width=3, fig.asp=0.6, dpi=300, fig.align="center"}
par(mar = c(4, 4, 2, 1), cex = 0.4)
plot(NULL, xlim = c(0, max(n_days)), ylim = c(0, max(malsim$n_detect_lm_730_3650 / malsim$n_age_730_3650,
                                                     simple$n_detect_730_3650 / simple$n_730_3650
                                                     )),
     xlab = "Time (Days)", ylab = expression(italic(Pf)~PR[2-10]))

abline(v = itn_days, col = "#619CFF", lty = 2, lwd = 0.7) 
abline(v = irs_days, col = "#00BA38", lty = 2, lwd = 0.7) 

for (i in unique(malsim$repetition)) {
  lines(malsim$timestep[malsim$repetition == i], 
        malsim$n_detect_lm_730_3650[malsim$repetition == i] / malsim$n_age_730_3650[malsim$repetition == i], 
        col = rgb(0, 0, 0, alpha = 0.4), lty = 1, lwd = 0.7)
}

lines(simple$time, 
      simple$n_detect_730_3650 / simple$n_730_3650, 
      col = "#CA0020", lwd = 1)

legend("topright", legend = c("malariasimple", "malariasimulation", "ITN distribution", "IRS distribution"),
       col = c("#CA0020","black", "#619CFF", "#00BA38"),
       lty = c(1,1,1,2,2), lwd = c(1,0.7,0.7,0.7,0.7), bty = "o", cex = 0.8)
```


